name: Terraform + Ansible CI/CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ğŸ” AWS credentials available to ALL steps
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ----------------------------
    # Terraform
    # ----------------------------
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init

    - name: Terraform Validate
      run: terraform validate

    - name: Terraform Plan
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan

    # ----------------------------
    # Get Docker Server IP
    # ----------------------------
    - name: Get Docker Server IP
      run: |
        set -e
        DOCKER_IP=$(terraform output -raw docker_server_public_ip)
        echo "Docker IP is: $DOCKER_IP"
        echo "DOCKER_IP=$DOCKER_IP" >> $GITHUB_ENV

    # ----------------------------
    # SSH Key from Terraform
    # ----------------------------
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        terraform output -raw ssh_private_key > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ss
